apiVersion: v1
kind: PersistentVolume
metadata:
  name: {{.Values.env.namespace}}-{{.Values.env.name}}-pv
spec:
  capacity:
    storage: 10Gi                  # ignored by S3, required by K8s
  accessModes: [ ReadOnlyMany ]
  storageClassName: ""             # static provisioning
  claimRef:
    namespace: {{.Values.env.namespace}}
    name: {{.Values.env.name}}-pvc
  csi:
    driver: s3.csi.aws.com
    volumeHandle: s3-csi-{{.Values.env.namespace}}-{{.Values.env.name}}   # <- UNIQUE per PV
    volumeAttributes:
      bucketName: {{.Values.persistence.bucket}}
  mountOptions:
    - "--region={{.Values.persistence.region}}"
    - "--prefix=triton/{{.Values.env.namespace}}/{{.Values.env.name}}/models/"
    - "--uid=1000"
    - "--gid=1000"
    - "--read-only"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{.Values.env.name}}-pvc
  namespace: {{.Values.env.namespace}}
  labels:
    dominodatalab.com/external-data-volume: Generic
spec:
  accessModes: [ ReadOnlyMany ]
  storageClassName: ""
  resources:
    requests:
      storage: 10Gi
  volumeName: {{.Values.env.namespace}}-{{.Values.env.name}}-pv
